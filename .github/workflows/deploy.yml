name: Deploy
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: CI/CD
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Enable Corepack
        run: corepack enable
      - run: yarn install --immutable
      - name: Restore Turbo build cache
        uses: actions/cache@v3
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/yarn.lock') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ hashFiles('**/yarn.lock') }}-
            ${{ runner.os }}-turbo-
      - run: yarn turbo run build
      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}
      - run: |
          doctl registry login --expiry-seconds 600
          docker build -t registry.digitalocean.com/parlay-edge/edge:${{ github.sha }} .
          docker push registry.digitalocean.com/parlay-edge/edge:${{ github.sha }}
          doctl serverless deploy parlay-edge \
            --env OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            --env ODDS_API_KEY=${{ secrets.ODDS_API_KEY }} \
            --env TWILIO_SID=${{ secrets.TWILIO_SID }} \
            --env TWILIO_TOKEN=${{ secrets.TWILIO_TOKEN }} \
            --env TWILIO_FROM=${{ secrets.TWILIO_FROM }} \
            --env TWILIO_TO=${{ secrets.TWILIO_TO }} \
            --image registry.digitalocean.com/parlay-edge/edge:${{ github.sha }}
